---
- block:
  # FIXME: add new iptabls rules
  - name: "Accept traffic on minions to k8s_contr"
    iptables:
      chain: INPUT
      protocol: tcp
      source: "{{ groups['k8s_contr'] | join(',') }}"
      destination_port: '22'
      jump: ACCEPT
      action: insert
    run_once: True

  - name: Upgrade hosts
    sudo: yes
    sudo_user: ubuntu
    shell: |
      bash -x scripts/upgrade-host.sh | tee -a logs
    ignore_errors: yes
    run_once: True

  - name: remove nano
    sudo: yes
    sudo_user: ubuntu
    shell: |
      sudo apt remove -y nano | tee -a logs
    ignore_errors: true

  - name: install other packages
    sudo: yes
    sudo_user: ubuntu
    shell: |
      sudo apt update | tee -a logs
      sudo apt install -y vim htop ccze | tee -a logs
    ignore_errors: true

  - when: not setup_minikube
    name: Install NFS common package
    shell: |
      sudo apt install -y nfs-common python-wheel | tee -a logs
    ignore_errors: false
